package hello;

import hello.api.*;
import hello.cache.MemCache;
import hello.dao.UserRepository;
import hello.dao.pojo.BannerInfo;
import hello.dao.pojo.Notice;
import hello.pojo.*;
import hello.service.BannerService;
import hello.service.CategoryService;
import hello.service.ProductService;
import hello.utils.KeywordsUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


// 这个就是专门用来做webservice使用的，直接输入JSON结果，用来做服务端的接口交互使用。

@Controller
public class ProductController {

    @Autowired // This means to get the bean called userRepository
    // Which is auto-generated by Spring, we will use it to handle the data
    private UserRepository userRepository;


    @Autowired
    private BannerService bannerService;

    @Autowired
    private ProductService productService;

    @Autowired
    private CategoryService categoryService;

    @RequestMapping("/greeting")
    public String greeting(@RequestParam(value = "name", required = false, defaultValue = "World") String name, Model model) {
        model.addAttribute("name", name);
        return "greeting";
    }


    @RequestMapping("/greetingall")
    public String greetingall(Model model) {
        model.addAttribute("users", userRepository.findAll());
        return "greetingall";
    }

    @RequestMapping(value = {"/index.html", "/"})
    public String index(Model model) {
        List<BannerInfo> bannerInfoList = (List<BannerInfo>) MemCache.getInstance().get("bannerList");
        if (bannerInfoList == null) {
            bannerInfoList = bannerService.findAll();
            MemCache.getInstance().put("bannerList", bannerInfoList);
        }

        model.addAttribute("bannerList", bannerInfoList);

        buildFeaturedProducts(model, "New Arrival", "newArrivalProducts", "0");
        buildFeaturedProducts(model, "Hot Product", "hotProducts", "0");

        AFFSmartMatchAPI smartMatchAPI = new AFFSmartMatchAPI();
        smartMatchAPI.setIsPostRequest(true);
        smartMatchAPI.setNeedAopSignature();
        HashMap<String, String> sparamMap = new HashMap<String, String>();
        sparamMap.put("method", "aliexpress.affiliate.product.smartmatch");
        // Must have filed
        sparamMap.put("device_id", "null");
        sparamMap.put("tracking_id", AFFBaseAPI.TRACKING_ID);
        // can be empty
        sparamMap.put("product_id", "");
        sparamMap.put("device", "{}");
        sparamMap.put("site", "{}");
        sparamMap.put("app", "{}");
        sparamMap.put("user", "{}");
        sparamMap.put("target_currency", "USD");
        sparamMap.put("target_language", "en");
        smartMatchAPI.setParamMap(sparamMap);
        List<Product> smartMatchProductList = new ArrayList<>();
        try {
            String response = smartMatchAPI.request();
            AliexpressAffiliateProductSmartmatchResponse aliexpressAffiliateProductSmartmatchResponse = AFFSmartMatchAPI.getResult(response);
            if (aliexpressAffiliateProductSmartmatchResponse != null && aliexpressAffiliateProductSmartmatchResponse.getRespResult() != null && aliexpressAffiliateProductSmartmatchResponse.getRespResult().getRespCode() == 200) {
                smartMatchProductList = aliexpressAffiliateProductSmartmatchResponse.getRespResult().getResult().getProducts();
            }
            model.addAttribute("smartMatchProductList", smartMatchProductList);
        } catch (Exception e) {
            e.printStackTrace();
        }

        return "index";
    }


    @RequestMapping("/featuredProducts.html")
    public String FeaturedProducts(Model model, String promotionName, @RequestParam(defaultValue = "1", required = false) int pageNo) {
        buildFeaturedProducts(model, promotionName, "promotionProductList", pageNo + "");
        model.addAttribute("promotionName", promotionName);
        model.addAttribute("pageNo", pageNo);
        return "featuredProducts";
    }


    @RequestMapping("/smartProducts.html")
    public String smartProducts(Model model, @RequestParam(defaultValue = "1", required = false) int pageNo) {
        try {
            Map<String, Object> resultMap = AFFSmartMatchAPI.getFromNet("", pageNo);
            AliexpressAffiliateProductSmartmatchResponse response = (AliexpressAffiliateProductSmartmatchResponse) resultMap.get("result");
            if (response != null && response.getRespResult() != null && response.getRespResult().getRespCode() == 200) {
                model.addAttribute("smartProducts", response.getRespResult().getResult().getProducts());
                model.addAttribute("pageNo", pageNo);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "smartProducts";
    }


    private void buildFeaturedProducts(Model model, String promotionName, String result, String pageNo) {
        HashMap<String, String> newArrivalMap = new HashMap<>();
        newArrivalMap.put("target_language", "en");
        newArrivalMap.put("target_currency", "usd");
        newArrivalMap.put("page_no", pageNo);
        newArrivalMap.put("promotion_name", promotionName);

        AFFFeaturedPromoProductGetAPI featuredPromoProductGetAPI = new AFFFeaturedPromoProductGetAPI();
        featuredPromoProductGetAPI.setIsPostRequest(true);
        featuredPromoProductGetAPI.setNeedAopSignature();
        newArrivalMap.put("method", "aliexpress.affiliate.featuredpromo.products.get");
        featuredPromoProductGetAPI.setParamMap(newArrivalMap);
        try {
            String response = featuredPromoProductGetAPI.request();
            AliexpressAffiliateFeaturedpromoProductsGetResponse aliexpressAffiliateFeaturedpromoProductsGetResponse = AFFFeaturedPromoProductGetAPI.getResult(response);
            model.addAttribute(result, aliexpressAffiliateFeaturedpromoProductsGetResponse.getRespResult().getResult().getProducts().subList(0, 20));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


    @RequestMapping("/queryById")
    public String queryById(@RequestParam Integer userId, Model model) {
        //model.addAttribute("uuu", userRepository.findOne(new Long(userId)));
        return "queryById";
    }


    @RequestMapping("/getProduct")
    public String getProduct(@RequestParam String id, Model model) {
        AFFProductDetailGetAPI affProductDetailGetAPI = new AFFProductDetailGetAPI();
        affProductDetailGetAPI.setIsPostRequest(true);
        HashMap<String, String> paramMap = new HashMap<>();
        paramMap.put("method", "aliexpress.affiliate.productdetail.get");
        paramMap.put("product_ids", id);
        paramMap.put("fields", "productId,productTitle,productUrl,imageUrl,originalPrice,salePrice,discount,evaluateScore,30daysCommission,volume,packageType,lotNum,validTime,storeName,storeUrl,allImageUrls");
        affProductDetailGetAPI.setParamMap(paramMap);
        try {
            String result = affProductDetailGetAPI.request();
            AliexpressAffiliateProductdetailGetResponse response = AFFProductDetailGetAPI.getResult(result);
            Product product = response.getRespResult().getResult().getProducts().get(0);
            model.addAttribute("product", product);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "getProduct";
    }


    @RequestMapping("/queryByFirstName")
    public String queryByFirstName(@RequestParam String firstName, Model model) {
        model.addAttribute("users", userRepository.findByFirstNameEndsWith(firstName));
        return "queryByFirstName";
    }


    @RequestMapping("/findByEmail")
    public String findByEmail(@RequestParam String email, Model model) {
        model.addAttribute("user", userRepository.findByEmailAddress(email));
        return "findByEmail";
    }


    @RequestMapping("/product.html")
    public String detail(@RequestParam(required = false) String id, Model model, @RequestParam(required = false) String productId) {
        if (productId != null) {
            id = productId;
        }
        queryProductById(id, model);
        return "product";
    }

    private String queryProductById(String productId, Model model) {
        Map<String, String> productParamsMap = new HashMap<>();
        AFFProductDetailGetAPI affProductDetailGetAPI = new AFFProductDetailGetAPI();
        affProductDetailGetAPI.setNeedAopSignature();
        affProductDetailGetAPI.setIsPostRequest(true);
        productParamsMap.put("method", "aliexpress.affiliate.productdetail.get");
        productParamsMap.put("product_ids", productId);
        String localCurrency = "USD";
        String language = "en";
        productParamsMap.put("target_currency", localCurrency);
        productParamsMap.put("target_language", language);
        productParamsMap.put("fields", "productId,productTitle,productUrl,imageUrl,originalPrice,salePrice,discount,evaluateScore,30daysCommission,volume,packageType,lotNum,validTime,storeName,storeUrl,allImageUrls");

        affProductDetailGetAPI.setParamMap(productParamsMap);

        Product product = null;
        try {
            if (MemCache.getInstance().get(productId) != null) {
                product = (Product) MemCache.getInstance().get(productId);
            } else {
                String response = affProductDetailGetAPI.request();
                AliexpressAffiliateProductdetailGetResponse productDetailGetResponse = AFFProductDetailGetAPI.getResult(response);
                if (productDetailGetResponse != null && productDetailGetResponse.getRespResult() != null && productDetailGetResponse.getRespResult().getRespCode() == 200) {
                    product = productDetailGetResponse.getRespResult().getResult().getProducts().get(0);
                    if (product != null) {
                        MemCache.getInstance().put(productId, product);
                    }
                } else {
                    Notice notice = new Notice();
                    notice.message = "Product not found.";
                    model.addAttribute("message", notice);
                    return "notice";
                }
            }

            model.addAttribute("product", product);
        } catch (Exception e) {
            e.printStackTrace();
        }


        AFFSmartMatchAPI smartMatchAPI = new AFFSmartMatchAPI();
        smartMatchAPI.setIsPostRequest(true);
        smartMatchAPI.setNeedAopSignature();
        HashMap<String, String> sparamMap = new HashMap<String, String>();
        sparamMap.put("method", "aliexpress.affiliate.product.smartmatch");
        // Must have filed
        sparamMap.put("device_id", "null");
        sparamMap.put("tracking_id", AFFBaseAPI.TRACKING_ID);
        // can be empty
        sparamMap.put("product_id", productId);
        sparamMap.put("device", "{}");
        sparamMap.put("site", "{}");
        sparamMap.put("app", "{}");
        sparamMap.put("user", "{}");
        sparamMap.put("target_currency", "USD");
        sparamMap.put("target_language", "en");
        smartMatchAPI.setParamMap(sparamMap);
        List<Product> smartMatchProductList = new ArrayList<>();
        try {
            if (MemCache.getInstance().get("smartResult_" + productId) != null) {
                smartMatchProductList = (List<Product>) MemCache.getInstance().get(productId);
            } else {
                String response = smartMatchAPI.request();
                AliexpressAffiliateProductSmartmatchResponse aliexpressAffiliateProductSmartmatchResponse = AFFSmartMatchAPI.getResult(response);
                if (aliexpressAffiliateProductSmartmatchResponse != null && aliexpressAffiliateProductSmartmatchResponse.getRespResult() != null && aliexpressAffiliateProductSmartmatchResponse.getRespResult().getRespCode() == 200) {
                    smartMatchProductList = aliexpressAffiliateProductSmartmatchResponse.getRespResult().getResult().getProducts().subList(0, 16);
                    MemCache.getInstance().put("smartResult_" + productId, smartMatchProductList);
                }
            }
            model.addAttribute("smartMatchProductList", smartMatchProductList);
        } catch (Exception e) {
            e.printStackTrace();
        }

        // build seo info
        if (product != null) {
            StringBuffer longText = new StringBuffer();
            for (int i = 0; i < smartMatchProductList.size(); i++) {
                Product p = smartMatchProductList.get(i);
                longText.append(p.getProductTitle()).append(" ");
            }
            product.setKeywords(product.getFirstLevelCategoryName() + ","
                    + product.getSecondLevelCategoryName() + ","
                    + KeywordsUtils.getSEOKeywords(KeywordsUtils.getKeywordsFromLongText(longText.toString())));
        }
        return null;
    }

    @RequestMapping("/search.html")
    public String queryProductDetailBySearch(@RequestParam String keywords, @RequestParam(defaultValue = "1", required = false) int pageNo, @RequestParam(defaultValue = "", required = false) String sort, Model model) {
        try {
            AliexpressAffiliateProductQueryResponse aliexpressAffiliateProductQueryResponse = AFFProductQueryAPI.getFromNet(keywords, pageNo + "", sort);
            model.addAttribute("trafficProductResultDto", aliexpressAffiliateProductQueryResponse.getRespResult().getResult());
            model.addAttribute("keywords", keywords);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "search";
    }

    // 展示类目导航页
    @RequestMapping("/category.html")
    public String category(Model model) {
        try {
            List<Category> categoryList;
            if (MemCache.getInstance().get("categoryList") != null) {
                categoryList = (List<Category>) MemCache.getInstance().get("categoryList");
            } else {
                categoryList = categoryService.findAll();
                MemCache.getInstance().put("categoryList", categoryList);
            }
            model.addAttribute("categoryList", categoryList);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return "category";
    }

    // 展示类目导航页
    @RequestMapping("/categoryItem.html")
    public String categoryItems(@RequestParam Long categoryId, @RequestParam(defaultValue = "1", required = false) int pageNo, @RequestParam(defaultValue = "", required = false) String categoryName, Model model) {
        try {
            Map<String, Object> resultMap = AFFHotProductDownloadAPI.getFromNet(categoryId, pageNo + "");
            model.addAttribute("categoryProductList", ((AliexpressAffiliateHotproductDownloadResponse) resultMap.get("result")).getRespResult().getResult().getProducts());
            model.addAttribute("categoryId", categoryId);
            model.addAttribute("pageNo", pageNo);
            model.addAttribute("categoryName", categoryName);
        } catch (Exception e) {
            e.printStackTrace();
        }

        return "categoryItem";
    }

}